# Redux

Практика к курсу https://maxfarseer.gitbooks.io/redux-course-ru-v2/content/.

## Описание

Приложение запрашивает разрешение на доступ к аккаунту VK, выгружает фотографии и показывает их с фильтром по году.

Для локальной разработки необходимо изменить id приложения VK в файле `public/index.html`.

## Хранилище

Все данные уровня приложения хранятся в отдельном Хранилище (**Store**). Их нельзя менять напрямую - для взаимодействия Хранилище предоставляет ряд методов.

Создание Хранилища осуществляется функцией `createStore(rootReducer, [initialState], [enhancer])`.

В коде: [store/configureStore.js](./src/store/configureStore.js).

Для связки Redux с React используется пакет `react-redux`. Он предоставляет компонент `Provider`, который оборачивает приложение. Провайдеру нужно передать созданный объект Хранилища.

В коде: [index.js](./src/index.js).

## Действия

Чтобы внести изменения в Хранилище создаются Действия (**Actions**). Каждое Действие имеет тип (`type`), который однозначно определяет, какое изменение необходимо. Дополнительно Действие может иметь поле `payload`, содержащее любую вспомогательную информацию.

Действие - это простой объект, но для его создания используются функции - Создатели Действий (**Action creators**). Эти функции не являются частью Redux, но используются повсеместно, так как позволяют параметризировать объекты Действий.

Кроме того, Создатели Действий могут использоваться для асинхронных изменений хранилища (об этом позже).

В коде:

* Действия страницы (загрузка фотографий из VK) - [actions/PageActions.js](./src/actions/PageActions.js)
* Действия юзера (авторизация через VK) - [actions/UserActions.js](./src/actions/UserActions.js)

Чтобы применить Действие используется метод `dispatch(Action)`, принадлежащий объекту хранилища.

`react-redux` позволяет не работать с этим методом напрямую, а преобразовать его в пропсы компонента. Для этого используется функция `connect()`.

## Connect

Функция `connect(mapStateToProps, mapDispatchToProps)` из пакета `react-redux` создает прослойку между методами хранилища и данными, которые в нем находятся, и компонентами react-приложения. Эта функция оборачивает компонент.

Функция `mapStateToProps(store)` получает объект хранилища и забирает из него нужные компоненту данные. Это автоматически привязывает компонент к этим данным. При их изменении компонент будет отрендерен заново.

Функция `mapDispatchToProps(dispatch)` получает метод `dispatch(action)`, который применяет Действие к хранилищу. Здесь можно создать все действия, которыми компонент будет пользоваться.

В коде:

* Контейнер страницы - [containers/PageContainer.js](./src/containers/PageContainer.js)
* Контейнер пользователя - [containers/UserContainer.js](./src/containers/UserContainer.js)

## Редьюсеры

Между Действием и реальным изменением Хранилища находится Редьюсер (**Reducer**). Это простая чистая функция, которая принимает текущее состояние приложения (state) и Действие, которое должно на него повлиять. Редьюсер возвращает новое состояние (новый объект).

Редьюсер передается в функцию `createStore()` первым параметром, так как он непосредственно влияет на состояние приложения.

Redux позволяет разделить ответственность за состояние на несколько Редьюсеров. Для их объединения используется функция `combineReducers()`.

В коде:

* Редьюсер страницы (обрабатывает Действия страницы) - [reducers/page.js](./src/reducers/page.js)
* Редьюсер пользователя (обрабатывает Действия пользователя) - [reducers/user.js](./src/reducers/user.js)
* Корневой Редьюсер (объединяет Редьюсеры страницы и пользователя) - [reducers/index.js](./src/reducers/index.js)

## Усилители

Усилители (**Enhancers**) в Redux - это middleware, которое располагается в цепочке между созданием Действия и его обработкой в Редьюсере. Таким образом, Усилители могут перехватывать Действие и производить какие-то сторонние эффекты, например, логировать его.

Усилители должны быть переданы в функцию `createStore()`. Для этого используется функция `applyMiddleware()`.

В коде: [store/configureStore.js](./src/store/configureStore.js).

Усилитель - это функция в двух обертках. Первая (внешняя) обертка принимает параметром объект хранилища и сохраняет его в замыкании. Эту обертку разворачивает как раз `applyMiddleware()`.

То, что осталось, вызывается методом `dispatch()`. Здесь снимается вторая обертка, которая получает функцию `next()`. Эта функция позволяет продолжить цепочку обработки Действия.

И наконец остается сам Усилитель, который получает объект Действия.

Кастомная реализация логгера-усилителя в коде: [store/enhancers/ping.js](./src/store/enhancers/ping.js).

## Асинхронное изменение состояния

Редьюсер ожидает на вход объект Действия - обычный объект с полем `type`. Создатели Действий должны этот объект возвращать. Он передается в `dispatch()`, проходит по всей цепочке Усилителей и попадает в Редьюсер.

Такая схема не позволяет вызывать Действия асинхронно.

Пример:

При нажатии на кнопку должен отправляться запрос на сервер для получения некоторых данных.

1. В `mapDispatchToProps(dispatch)` создаем функцию `getData()` и вызываем ее при клике на кнопку.
2. Внутри `getData()` нам нужно задиспатчить Действие отправки запроса, чтобы состояние приложения изменилось и на страницу вывелся прелоадер.
3. Пишем Создатель Действия, который отправит запрос и вернет объект Действия отправки запроса, который можно задиспатчить.
4. Но когда вернется ответ с сервера, мы никак не сможем его обработать, ведь внутри Создателя Действия нет доступа к функции `dispatch()`.

Можно, конечно, передать `dispatch` в Создатель действия внутри `mapDispatchToProps`, но это довольно грязный подход, который нарушает идею Создателей действий.

Чтобы решить эту проблему, можно использовать Усилитель `redux-thunk`. Он позволяет возвращать из Создателя Действия не объект, а функцию. Когда эта функция попадает в Усилитель redux-thunk, он передает в нее метод `dispatch` и вызывает. (Усилитель имеет доступ к объекту Хранилища и его методам).

В коде:

* Подключение redux-thunk - [store/configureStore.js](./src/store/configureStore.js)
* Действия страницы (загрузка фотографий из VK) - [actions/PageActions.js](./src/actions/PageActions.js)
* Действия юзера (авторизация через VK) - [actions/UserActions.js](./src/actions/UserActions.js)
